# 6월 19일


## API 개발3 - 유저 아이디를 암호화하기
### 비밀번호 처리 라이브러리
- 비밀번호는 항상 암호화 된 것이 DB에 저장되어있어야 함.
- 양방향 암호화를 사용하면 안됨 : 코드 한줄로 금방 번역할 수 있기 때문에
- 단방향 암호화를 사용해야 한다(hash)
- 단방향 암호화를 사용할경우 같은 비번도 암호화할 때마다 다른 암호로 저장되기때문에 서버 개발자도 해석이 불가하고 입력한 사람만(유저) 비번을 알 수 있다.
#### 비밀번호 처리 라이브러리 설치
```
### pip install psycopg2-binary
### pip install passlib
```

### JWT 사용하기
- 유저 아이디는 클라이언트와 데이터베이스가 주고받는 정보를 포함하고 있기 때문에 전송되는동안 노출되지 않는게 중요하다.
- 이를 위해 보안 토큰을 이용해야 한다.
- 많이 쓰이는 보안 토큰이 JWT 라이브러리.
- 
#### 설치방법 및 flask에서 설정 방법
- 가상환경의 터미널에 Flask-JWT-Extended 를 설치한다
    ```
    pip install Flask-JWT-Extended
    ```
- 서버의 메인 페이지로 이동해서 라이브러리를 import 해준다
    ```
    from flask_jwt_extended import JWTManager
    ```
- config.py 파일에 jwt의 변수를 세팅해준다
    ```
    # 여기서 변수의 이름은 우리가 정해서 쓰는게 아니라, 정해져 있는 변수이름이다.
        JWT_SECRET_KEY = '임의의 문자열 세팅'
        JWT_ACCESS_TOKEN_EXPIRES = False  # 자동로그아웃 할래? -False : 아니오
        PROPAGATE_EXCEPTIONS = True       # 문제 생기면 유저에게 보여줄래? True : 예
    ```

#### 회원가입/ 로그인 API에서 토큰 생성해서 처리하는 방법
- 암호화 인증토큰 적용하기
    ```
    # 라이브러리 임포트
    # from flask_jwt_extended import create_access_token

    return { 'result' : 'success', 'user_id': result_list[0]['id'] } 
    # 여기서 단순히 user_id 자리에 정말 유저 아이디를 적어서 보내면 보안에 위협이 되므로
    # 유저 아이디를 토큰을 이용하여 암호화 해서 보냄

    # 함수 정의 아래 다음과 같은 코드 추가
    access_token = create_access_token(user_id)
    ```
- 위 코드를 작성한 후 서버를 다시 올리고 포스트맨에서 로그인 API 실행
- 성공했다면 인증토큰이 뜸


#### 로그인한 유저만 처리할 수 있는 API에 토큰 적용하는 방법
- 그 인증토큰을 복사해서 수정, 삭제 API 로 이동
- 헤더의 values에 'Bearer + "(띄어쓰기) " + 인증토큰' 입력



#### 토큰 유효기간 만료시키는 방법
```
# 토큰을 만들때 파라미터를 추가할 수 있음.
create_access_token(user_id, expires_delta=datetime.timedelta(days=10))
        # timedelta(days=10) : 10일 지나면 로그인 꺼짐.
```

#### 로그아웃 시키는 방법
- 로그인 시 생성된 인증토큰을 로그아웃 API의 헤더에 입력
- API를 실행시키면 로그아웃됨.



# 오늘의 문제점 및 해결방안
### 문제점
- 1번 유저가 2번 유저의 포스트 내용을 삭제시키지 못하게 암호를 걸었는데도 삭제를 할 수 있었음.

### 해결방법
- 1번 유저로 로그인을 한 후 로그아웃 하지 않고 2번유저로 로그인을 했기 때문.
- 1번 유저가 로그아웃되지 않은 상태에서 2번 유저로 로그인을 했고, 그대로 2번 유저가 1번 유저의 포스트를 삭제하는 명령어를 내렸기때문에 1번 유저의 포스트가 삭제됨.
- 1번 유저 계정을 로그아웃 하고 난 후 2번유저가 1번유저의 포스트를 삭제하려고 시도 -> 삭제되지 않음.


