# 5월 26일

## AWS EC2 인스턴스 가상환경 설치
### 가상환경 설치 및 대시보드 내용 적용하기
설치를 위해서 리눅스를 열어야함.
푸티 프로그램을 이용해 EC2 인스턴스에 접속
유저 로그인을 함
다음을 터미널에 입력
```
# 파이썬 가상환경 설치
$ conda create -n app_dash(가상환경 이름) python=3.9 openssl numpy scipy matplotlib ipython scikit-learn pandas pillow jupyter seaborn
```

가상환경 설치 후 가상환경으로 들어감
```
$ conda activate app_dash  # 가상환경 들어가기

$ pip install plotly==5.14.1    #  plotly 설치
$ pip install joblib==1.2.0     #  joblib 설치
```

대시보드 내용 소스코드 받아서 설치할 폴더를 하나 만들기
```
$ mkdir Github
$ cd Github/                   # 깃허브 폴더 안으로 들어가기
```

이제 깃허브에서 내가 올려둔 대시보드 코드를 가져와야함
깃허브의 대시보드 레포지토리에 들어가서 코드 클릭 -> 클론 누르고 -> https 주소 복사
깃을 리눅스에 설치
```
$ sudo yum install git
```

sudo : 수퍼 유저로서 이 명령어를 수행해라 프로그램 설치해라
yum : 센트OS에서 리눅스용 프로그램을 설치할떄 쓰는 명령어
설치 한 후 깃허브에서 클론, 푸시, 풀 다 가능
브랜치를 프라이빗으로 만들었다면 로그인 한번 더 하라고 나옴
프라이빗으로 만들었다면 로그인 시 보안토큰이 필요함
보안 토큰을 만드는 법
깃허브의 세팅 -> 디벨로퍼 세팅(맨아래) -> 
퍼스널 어쎼스 토큰 -> 토큰 -> 제너레이트 뉴 토큰(클래식)
설명 적고 -> 기간 제한 설정함 -> 셀렉트 스콥에서 repo만 선택(체크) 
-> 제너레이트 토큰(맨 아래)
-> 토큰 하나 생기는데 무조건 복사해놓기. 페이지 나가면 다시 안뜸.
리눅스로 돌아와서 발급받은 보안토큰으로 로그인

브랜치 클론하기
```
$ git clone 복사한 레포지토리 주소
```

앱 대시보드 폴더 안으로 들어가기

스트림릿 실행
```
$ streamlit run app.py
```

앱 대시보드를 퍼블릭 아이피 주소를 통해 인터넷으로 들어가려해도 아무것도 안뜸
-> 보안떄문에
방화벽 설정을 해 주어야 함
방화벽 설정 바꿔주는 방법

```
 AWS 콘솔 홈 로그인 -> EC2 대시보드에서 인스턴스 
 -> 앱 대시보드 서버 이름 클릭 -> 밑 부분에 보안 탭 클릭 
 -> (인바운드는 AWS로들어오는거, 아웃바운드는 AWS에서 나가는 규칙)
 -> 보안그룹 클릭 -> 인바운드 규칙 편집 
 -> 규칙 추가 
 -> 포트범위 써줌 ( 리눅스 스트림릿 런 하면나오는 맨 뒤 숫자)
 -> 설명 써도 되고 안써도 됨
 -> 규칙 저장
 -> 웹페이지의 내 대시보드 들어가봄
 -> 페이지가 정상적으로 나오면 성공
```

### 터미널을 닫아도 백그라운드에서 계속 돌아가도록 설정하기
리눅스를 종료하면 웹페이지의 대시보드도 실행되지 않음
터미널을 닫을때마다 명령어가 다 사라지기 때문
24시간 계속 돌아가는 명령어를 입력 해 줘야 함
```
 # 명령어 : $ nohup streamlit run app.py &
 # 명령어 설명 :
 nohup                   streamlit run app.py    &
 (터미널 닫아도 돌아라)                           (백그라운드에서 돌아라)
 # 돌아가는걸 멈추고 싶다면 : $ nohup.out
```

### 설치한 가상환경 들어가는 과정
PuTTY 실행
리눅스의 앱 대시보드로 들어가기
유저로그인
가상환경 들어가기 : 
```
$ conda activate app_dash 
$ cd Github/
$ cd car_price_dash_board

# 내가 대시보드 작업 한 폴더 안까지 들어가서 스트림릿 실행
$ streamlit run app.py
```

### 앱 대시보드를 수정하기
```
# --------------------<<문제>>----------------------------
# 홈 화면
# 웰컴 대신 안녕하세요로 바꿔달라는 요청 들어온다면
# (수정하려면?)
# ------------------------------------------------------------
```
1. 서버에서 작업하기 ===>> 이렇게 작업하면 큰일남! 하지 말자!
```
# 하지만 방법은 알아두자

# 터미널 들어가서 가상환경열고 대시보드 폴더까지 들어가서
# 필요한 부분의 파이썬 파일을 수정하기 ->

# - vim 프로그램 열어서 (터미널에 vim 입력) 
# 여기서 대시보드 수정할 수 있음
# (vim 나가는 방법 : esc + : + q )

```
2. 깃허브에서 수정하기 ===>> 지금껏 이렇게 수정 해 본적 없음
 - 깃허브는 버전 컨트롤 시스템이지 개발 시스템 아님.

3. **내 컴퓨터 VS코드 열어서 수정** ===>> 이 방법으로 수정하자!
(1)
- 코드 수정하기
- 저장하기
- 잘 돌아가는지 확인하기(=테스트하기 => "유닛(unit)테스트" 라고 함.)
- 터미널 끄기
- 깃허브에 푸시  
- 깃허브에서 수정된 내용 확인하기
  
(2)
- 깃허브에 있는 내용 AWS에 "풀" 하기

  Q . 풀 만 하면 자동반영되나? -->>
 	- 터미널에서 경로 확인하고 프로젝트 폴더 맞는지 확인
	- 'git pull' 입력하고 엔터
 	- 깃허브 아이디랑 보안토큰 입력(프라이빗 폴더일 경우)
 	- 'll(LL')눌러서 파일 확인
 	- 파일 내용 확인할 수 있는 프로그램으로 내용 바뀌었는지 확인
 	- 변경 내용이 있는 폴더 앞에 cat 붙여 입력하면 됨.
 	- 'cat app_home.py'
 	- 풀 했으므로 변경 내용이 바뀌었음을 확인
 	- 앱 대시보드로 가서 수정된 내용 반영되었는지 확인
 	  (원래는 웹페에지에 Always rerun 나와야 하는데 요새는 그냥 반영됨.)


### 깃허브에서 AWS로 Pull(자동)
### 깃허브로 수정내용 올리면 자동 배포되도록 깃허브 설정하기
- Github Actions 이용한 CI/CD
- Agile(애자일) 개발방식
- 짧은 주기의 개발단위를 반복하여 하나의 큰 프로젝트를 완성해나가는 방식

1. 깃허브가 EC2에 접속할 권한이 필요하므로 깃허브용 토큰을 하나 더 발급해야함.
    1) ppk 파일을 pem파일로 변환해야 하는데 PuTTY key gen 이라는 프로그램 필요
    2) PuTTY 다운 받을때 같이 다운받아져있으므로 찾기로 프로그램을 찾아서 실행하면 됨.
    3) ppk 파일 로드 -> 메뉴탭의 컨버젼 클릭 -> 두번째의 export open SSH key 누르고 저장 상자가 뜨면 이름은 원래 파일과 같이 하고 확장명만 pem으로 바꿔서 저장.
2. 접속준비
   1) 깃허브의 프로젝트가 있는 리포지토리로 들어가서 리포지토리 세팅 메뉴 클릭
   2) 왼쪽의 메뉴탭 - Security - Secrets and variables - Actions 클릭
   3) Secrets 와 variables 의 탭 중 Secrets 를 누르고 New repository secret 버튼 클릭
   4) 총 4개의 repository secret 를 만들어야 함.
   
```
### 4개의 repository secret 중 선행 2가지

# 1)
# 키네임 적기 : SSH_PRIVATE_KEY
# 시크릿 적기 : -> 여기가 중요
# pem 파일 만든 폴더 열어서 pem파일을 끌어다 시크릿의 박스 안으로 집어넣기
# 웹 브라우저에 글자들이 뜸 -> 뜬 내용을 잘 복사
# 다시 시크릿의 박스로 가서 붙여넣기
# 애드 시크릿 버튼 누르기

# 2)
# 네임 : HOST 
# 내용 : 아이피주소(나의 EC2 인스턴스 퍼블릭 아이피 주소)

# 3)
# 네임 : USER
# 내용 : ec2-user
```
이후  진행

    1) 프로젝트가 있는 리포지토리의 메뉴 중 액션 탭 클릭. 많은 템플릿들이 있으나, 연습이므로 직접 만들어봄.
    2) 서브타이틀 글자 밑으로 set up a workflow yourself 클릭
    3) 에디트 상자에 다음의 코드를 붙여넣기 함
   
```
### 들여쓰기 중요함 복사 붙여넣기 하는게 오류가 안나올 수 있음

# ------------ 복사하기 --------------------------------

# name: deploy

# # Controls when the workflow will run
# on:
#   # Triggers the workflow on push or pull request events but only for the main branch
#   push:
#     branches:
#       - main


# jobs:
#   SSH:
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v3
#       - name: ssh to ec2
#         uses: appleboy/ssh-action@master
#         with:
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           host: ${{ secrets.HOST }}
#           username: ${{ secrets.USER }}
#           script: |
#             cd Github/car_price_dash_board/                        
#             git pull

# ----------------------------------------------------------
```
```
## 퍼블릭 리포지토리라면 맨 밑의 파일 경로만 나의 리눅스 앱 대시보드 파일 경로로 바꾸어 주면 됨.

## 리포지토리가 프라이빗이라면 파일 경로 + 그 밑의 git pull 부분도 수정해주어야 함

# 나의 파일 경로는 cd Github/car_price_dash_board/
# git pull 자리에 다음 코드 복붙
#   # git pull https://${{ secrets.GIT_USER }}:${{ secrets.GIT_PASSWORD }}@github.com/HYEEYH(지우는부분:나의깃허브이름)/car_price_dash_board(지우는부분:프로젝트가있는리포지토리).git
```

    6) 리포지토리가 프라이빗이라면 더 설정해주어야 하는 것들이 있음. 아까 repository secret 나머지 2개 추가해주어야 함.



### 4개의 repository secret 중 나머지 2가지
```
# 3)
# 네임 : GIT_USER 
# 내용 : HYEEYH


# 4)
# 네임 : GIT_PASSWORD 
# 내용 : 깃허브에서 발급받은 보안 토큰

```


## 리눅스 명령어 정리
ls : 간편보기
ls -al : 숨김파일까지 다 보기
ls -l 숨김파일 빼고 보여줘(L의 소문자) , 설치되었는지 확인할 때 써보기(숨김파일은 안보여줌)
    또는 ll(줄임말, 소문자L) 두개만 입력해도 됨.
shirt + insert 복사한거 붙여넣기

파일이나 디렉토리 삭제하는 명령어
rm -rf 디렉토리명(파일명)
(대신 한번 삭제하면 영구삭제. 복구할 수 없음)

esc + : + q 누르면 실행중인 프로그램에서 나갈 수 있음.

# 오늘의 유의할 점
## 경고메세지 풀이
(1)
```
# 
X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
```
별 문제는 없는 메세지.
학습할때 데이터프레임으로 학습했는데 예측을 넘파이로 해서 쓰는 경고
넘파이로 학습 하면 경고 뜨지 않음.


(2)
한개의 레파지토리에는 한가지 프로젝트만 있어야한다.
레파지토리에 한꺼번에 여러개의 프로젝트를 만들어서 코드를 실행하면
어떤걸 실행해야 할 지 몰라 오류가 나게 됨.

